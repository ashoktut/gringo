<div class="form-container">
  <h2 *ngIf="formTitle" class="form-title">{{ formTitle }}</h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dynamic-form">
    <!-- NEW: Grouped mode with sections -->
    <ng-container *ngIf="sections?.length; else flatMode">
      <mat-accordion [multi]="multi">
        <mat-expansion-panel
          *ngFor="let section of sections; trackBy: trackBySection"
          [expanded]="section.expanded || false"
        >
          <mat-expansion-panel-header>
            <mat-panel-title>{{ section.title }}</mat-panel-title>
            <mat-panel-description *ngIf="section.description">
              {{ section.description }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <ng-container
            *ngFor="let field of section.fields; trackBy: trackByFieldName"
          >
            <ng-container
              [ngTemplateOutlet]="fieldTemplate"
              [ngTemplateOutletContext]="{ $implicit: field }"
            >
            </ng-container>
          </ng-container>
        </mat-expansion-panel>
      </mat-accordion>
    </ng-container>

    <!-- UPDATED: Flat mode (backward compatible) -->
    <ng-template #flatMode>
      <ng-container *ngFor="let field of fields; trackBy: trackByFieldName">
        <ng-container
          [ngTemplateOutlet]="fieldTemplate"
          [ngTemplateOutletContext]="{ $implicit: field }"
        >
        </ng-container>
      </ng-container>
    </ng-template>

    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="form.invalid"
      >
        {{ submitButtonText }}
      </button>
    </div>
  </form>
</div>

<!-- NEW: Shared field template (moved all your existing field code here) -->
<ng-template #fieldTemplate let-field>
  <div [formGroup]="form" *ngIf="shouldShowField(field)">
    <!-- Input Fields (text, email, password, number, tel) -->
    <mat-form-field
      *ngIf="isInputField(field.type)"
      appearance="fill"
      class="full-width"
    >
      <mat-label>{{ field.label }}</mat-label>
      <input
        matInput
        [type]="field.type"
        [formControlName]="field.name"
        [placeholder]="field.placeholder || ''"
        [required]="!!field.required"
      />

      <!-- Clear button -->
      <button
        *ngIf="field.clearable"
        mat-icon-button
        matSuffix
        type="button"
        aria-label="Clear"
        (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
        (click)="clearField(field, $event)"
      >
        <mat-icon>close</mat-icon>
      </button>

      <mat-error *ngIf="hasFieldError(field.name)">
        {{ getFieldError(field.name) }}
      </mat-error>
    </mat-form-field>

    <!-- Date Picker -->
    <mat-form-field
      *ngIf="field.type === 'date'"
      appearance="fill"
      class="full-width"
    >
      <mat-label>{{ field.label }}</mat-label>
      <input
        matInput
        [matDatepicker]="picker"
        [formControlName]="field.name"
        [placeholder]="field.placeholder || 'DD/MM/YYYY'"
        [required]="!!field.required"
      />

      <!-- Clear button for date -->
      <button
        *ngIf="field.clearable"
        mat-icon-button
        matSuffix
        type="button"
        aria-label="Clear date"
        (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
        (click)="clearField(field, $event)"
      >
        <mat-icon>close</mat-icon>
      </button>

      <mat-datepicker-toggle
        matIconSuffix
        [for]="picker"
      ></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="hasFieldError(field.name)">
        {{ getFieldError(field.name) }}
      </mat-error>
    </mat-form-field>

    <!-- Select Dropdown -->
    <mat-form-field
      *ngIf="field.type === 'select'"
      appearance="fill"
      class="full-width"
    >
      <mat-label>{{ field.label }}</mat-label>
      <mat-select
        [formControlName]="field.name"
        [multiple]="!!field.multiple"
        [required]="!!field.required"
      >
        <mat-option *ngFor="let option of field.options" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>

      <!-- Clear button for select -->
      <button
        *ngIf="field.clearable"
        mat-icon-button
        matSuffix
        type="button"
        aria-label="Clear selection"
        (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
        (click)="clearField(field, $event)"
      >
        <mat-icon>close</mat-icon>
      </button>

      <mat-error *ngIf="hasFieldError(field.name)">
        {{ getFieldError(field.name) }}
      </mat-error>
    </mat-form-field>

    <!-- Textarea -->
    <mat-form-field
      *ngIf="field.type === 'textarea'"
      appearance="fill"
      class="full-width"
    >
      <mat-label>{{ field.label }}</mat-label>
      <textarea
        matInput
        [formControlName]="field.name"
        [placeholder]="field.placeholder || ''"
        [rows]="field.rows || 3"
        [required]="!!field.required"
      >
      </textarea>

      <!-- Clear button for textarea -->
      <button
        *ngIf="field.clearable"
        mat-icon-button
        matSuffix
        type="button"
        aria-label="Clear text"
        (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
        (click)="clearField(field, $event)"
      >
        <mat-icon>close</mat-icon>
      </button>

      <mat-error *ngIf="hasFieldError(field.name)">
        {{ getFieldError(field.name) }}
      </mat-error>
    </mat-form-field>

    <!-- Checkbox -->
    <div *ngIf="field.type === 'checkbox'" class="checkbox-field">
      <mat-checkbox [formControlName]="field.name">
        {{ field.label }}
      </mat-checkbox>
      <div *ngIf="hasFieldError(field.name)" class="mat-error">
        {{ getFieldError(field.name) }}
      </div>
    </div>

    <!-- Radio Group -->
    <div *ngIf="field.type === 'radio'" class="radio-field">
      <label class="field-label">{{ field.label }}</label>
      <mat-radio-group [formControlName]="field.name" class="radio-group">
        <mat-radio-button
          *ngFor="let option of field.options"
          [value]="option.value"
          class="radio-button"
        >
          {{ option.label }}
        </mat-radio-button>
      </mat-radio-group>
      <div *ngIf="hasFieldError(field.name)" class="mat-error">
        {{ getFieldError(field.name) }}
      </div>
    </div>

    <!-- MapLibre Map Field -->
    <div *ngIf="field.type === 'map'" class="map-field">
      <!-- Field label -->
      <label class="field-label">{{ field.label }}</label>

      <!-- Map picker component with all configuration options -->
      <app-map-libre-picker
        [formControlName]="field.name"
        [defaultCenter]="field.mapConfig?.defaultCenter || [28.0473, -26.2041]"
        [zoom]="field.mapConfig?.zoom || 10"
        [height]="field.mapConfig?.height || '400px'"
        [enableGeocoding]="field.mapConfig?.enableGeocoding !== false"
        [enableLocationPicker]="field.mapConfig?.enableLocationPicker !== false"
        [style]="field.mapConfig?.style || 'liberty'"
      >
      </app-map-libre-picker>

      <!-- Show validation errors if any -->
      <div *ngIf="hasFieldError(field.name)" class="mat-error">
        {{ getFieldError(field.name) }}
      </div>
    </div>

    <!-- 🖊️ Digital Signature Field -->
    <div *ngIf="field.type === 'signature'" class="signature-field">
      <!-- Digital signature component with all configuration options -->
      <app-digital-signature
        [formControlName]="field.name"
        [label]="field.label"
        [placeholder]="field.placeholder"
        [canvasWidth]="field.signatureConfig?.canvasWidth || 600"
        [canvasHeight]="field.signatureConfig?.canvasHeight || 200"
        [strokeColor]="field.signatureConfig?.strokeColor || '#000000'"
        [strokeWidth]="field.signatureConfig?.strokeWidth || 2"
        [backgroundColor]="field.signatureConfig?.backgroundColor || '#FFFFFF'"
      >
      </app-digital-signature>

      <!-- Show validation errors if any -->
      <div *ngIf="hasFieldError(field.name)" class="mat-error">
        {{ getFieldError(field.name) }}
      </div>
    </div>
  </div>
</ng-template>
