<div class="form-container">
  @if (formTitle) {
    <h2 class="form-title">{{ formTitle }}</h2>
  }

  <!-- Enterprise Features Header -->
  @if (enableCompanySelector || showFormProgress || autoSaveStatus() !== 'idle') {
    <div class="enterprise-header">
      <!-- Company Selector -->
      @if (enableCompanySelector && availableCompanies.length > 0) {
        <mat-form-field appearance="outline" class="company-selector">
          <mat-label>Select Company</mat-label>
          <mat-select
            [value]="currentCompanyId()"
            (selectionChange)="onCompanyChange($event.value)"
            [disabled]="isLoading()">
            @for (company of availableCompanies; track company.id) {
              <mat-option [value]="company.id">{{ company.name }}</mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>business</mat-icon>
          @if (enableFieldHints) {
            <mat-hint>Choose the company for this form submission</mat-hint>
          }
        </mat-form-field>
      }

      <!-- Form Progress -->
      @if (showFormProgress) {
        <div class="form-progress">
          <div class="progress-header">
            <span class="progress-text">
              Progress: {{ formProgress().completed }} / {{ formProgress().total }} fields
            </span>
            <mat-icon [color]="formProgress().completed === formProgress().total ? 'primary' : 'accent'">
              {{ formProgress().completed === formProgress().total ? 'check_circle' : 'progress_activity' }}
            </mat-icon>
          </div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              [style.width.%]="(formProgress().completed / formProgress().total) * 100">
            </div>
          </div>
        </div>
      }

      <!-- Auto-Save Status -->
      @if (enableAutoSave && autoSaveStatus() !== 'idle') {
        <div class="auto-save-status" [ngClass]="'status-' + autoSaveStatus()">
          <mat-icon>
            @if (autoSaveStatus() === 'saving') {
              cloud_upload
            } @else if (autoSaveStatus() === 'saved') {
              cloud_done
            } @else {
              cloud_off
            }
          </mat-icon>
          <span>{{ autoSaveStatusText() }}</span>
        </div>
      }

      <!-- Validation Errors Summary -->
      @if (enableValidationFeedback && validationErrors().length > 0) {
        <div class="validation-summary">
          <mat-icon color="warn">warning</mat-icon>
          <span>{{ validationErrors().length }} validation error(s)</span>
          <button mat-button color="warn" (click)="validateAllFields()">
            Review Errors
          </button>
        </div>
      }
    </div>
  }

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dynamic-form">
    <!-- NEW: Grouped mode with sections -->
    @if (sections?.length) {
      <mat-accordion [multi]="multi">
        @for (section of sections; track trackBySection($index, section)) {
          <mat-expansion-panel
            [expanded]="section.expanded || false"
            >
            <mat-expansion-panel-header>
              <mat-panel-title>{{ section.title }}</mat-panel-title>
              @if (section.description) {
                <mat-panel-description>
                  {{ section.description }}
                </mat-panel-description>
              }
            </mat-expansion-panel-header>
            @for (field of section.fields; track trackByFieldName($index, field)) {
              <ng-container
                [ngTemplateOutlet]="fieldTemplate"
                [ngTemplateOutletContext]="{ $implicit: field }"
                >
              </ng-container>
            }
          </mat-expansion-panel>
        }
      </mat-accordion>
    } @else {
      @for (field of fields; track trackByFieldName($index, field)) {
        <ng-container
          [ngTemplateOutlet]="fieldTemplate"
          [ngTemplateOutletContext]="{ $implicit: field }"
          >
        </ng-container>
      }
    }

    <!-- Enhanced Form Actions -->
    <div class="form-actions">
      <!-- Draft Actions -->
      @if (enableDraftMode) {
        <div class="draft-actions">
          <button
            mat-button
            color="accent"
            type="button"
            (click)="saveDraft()"
            [disabled]="!isDirty() || isLoading()">
            <mat-icon>save</mat-icon>
            Save Draft
          </button>
        </div>
      }

      <!-- Primary Submit -->
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="!isFormValid() || isLoading()"
        class="submit-button">
        @if (isLoading()) {
          <mat-spinner diameter="20" style="margin-right: 8px;"></mat-spinner>
        }
        {{ submitButtonText }}
      </button>

      <!-- Reset Button -->
      <button
        mat-button
        color="warn"
        type="button"
        (click)="resetForm()"
        [disabled]="!isDirty() || isLoading()">
        <mat-icon>refresh</mat-icon>
        Reset
      </button>

      <!-- PDF Generation Buttons -->
      <div class="pdf-actions" style="margin-left: 16px; display: flex; gap: 8px;">
        <!-- Generate PDF from HTML -->
        <button
          mat-stroked-button
          color="accent"
          type="button"
          (click)="generatePdfFromHtml()"
          [disabled]="!isFormValid() || isLoading()"
          matTooltip="Generate PDF using HTML template">
          <mat-icon>picture_as_pdf</mat-icon>
          PDF (HTML)
        </button>

        <!-- Generate PDF from DOCX - needs file input -->
        <input
          #docxFileInput
          type="file"
          accept=".docx"
          style="display: none;"
          (change)="onDocxFileSelected($event)">

        <button
          mat-stroked-button
          color="accent"
          type="button"
          (click)="docxFileInput.click()"
          [disabled]="!isFormValid() || isLoading()"
          matTooltip="Generate PDF from DOCX template">
          <mat-icon>description</mat-icon>
          PDF (DOCX)
        </button>
      </div>

      <!-- Debug info (only in development) -->
      @if (enableValidationFeedback) {
        <div class="debug-info" style="margin-top: 10px; font-size: 12px; color: #666;">
          <details>
            <summary>Form Debug Info</summary>
            Form Valid (Signal): {{ isFormValid() }}<br />
            Form Valid (Angular): {{ form.valid }}<br />
            Form Dirty: {{ isDirty() }}<br />
            Auto-Save: {{ autoSaveStatus() }}<br />
            Company: {{ currentCompanyId() || 'None' }}<br />
            Validation Errors: {{ validationErrors().length }}
          </details>
        </div>
      }
    </div>
  </form>
</div>

<!-- NEW: Shared field template (moved all your existing field code here) -->
<ng-template #fieldTemplate let-field>
  @if (shouldShowField(field)) {
    <div [formGroup]="form">
      <!-- Input Fields (text, email, password, number, tel) -->
      @if (isInputField(field.type)) {
        <mat-form-field
          appearance="fill"
          class="full-width"
          >
          <mat-label>{{ field.label }}</mat-label>
          <input
            matInput
            [type]="field.type"
            [formControlName]="field.name"
            [placeholder]="field.placeholder || ''"
            [required]="!!field.required"
            />
            <!-- Clear button -->
            @if (field.clearable) {
              <button
                mat-icon-button
                matSuffix
                type="button"
                aria-label="Clear"
                (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                (click)="clearField(field, $event)"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
            @if (hasFieldError(field.name)) {
              <mat-error>
                {{ getFieldError(field.name) }}
              </mat-error>
            }
          </mat-form-field>
        }
        <!-- Date Picker -->
        @if (field.type === 'date') {
          <mat-form-field
            appearance="fill"
            class="full-width"
            >
            <mat-label>{{ field.label }}</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || 'DD/MM/YYYY'"
              [required]="!!field.required"
              />
              <!-- Clear button for date -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear date"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-datepicker-toggle
                matIconSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Select Dropdown -->
          @if (field.type === 'select') {
            <mat-form-field
              appearance="fill"
              class="full-width"
              >
              <mat-label>{{ field.label }}</mat-label>
              <mat-select
                [formControlName]="field.name"
                [multiple]="!!field.multiple"
                [required]="!!field.required"
                >
                @for (option of field.options; track option) {
                  <mat-option [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                }
              </mat-select>
              <!-- Clear button for select -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear selection"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Textarea -->
          @if (field.type === 'textarea') {
            <mat-form-field
              appearance="fill"
              class="full-width"
              >
              <mat-label>{{ field.label }}</mat-label>
              <textarea
                matInput
                [formControlName]="field.name"
                [placeholder]="field.placeholder || ''"
                [rows]="field.rows || 3"
                [required]="!!field.required"
                >
              </textarea>
              <!-- Clear button for textarea -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear text"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Checkbox -->
          @if (field.type === 'checkbox') {
            <div class="checkbox-field">
              <mat-checkbox [formControlName]="field.name">
                {{ field.label }}
              </mat-checkbox>
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- Radio Group -->
          @if (field.type === 'radio') {
            <div class="radio-field">
              <label class="field-label">{{ field.label }}</label>
              <mat-radio-group [formControlName]="field.name" class="radio-group">
                @for (option of field.options; track option) {
                  <mat-radio-button
                    [value]="option.value"
                    class="radio-button"
                    >
                    {{ option.label }}
                  </mat-radio-button>
                }
              </mat-radio-group>
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- MapLibre Map Field -->
          @if (field.type === 'map') {
            <div class="map-field">
              <!-- Field label -->
              <label class="field-label">{{ field.label }}</label>
              <!-- Map picker component with all configuration options -->
              <app-map-libre-picker
                [formControlName]="field.name"
                [defaultCenter]="field.mapConfig?.defaultCenter || [28.0473, -26.2041]"
                [zoom]="field.mapConfig?.zoom || 10"
                [height]="field.mapConfig?.height || '400px'"
                [enableGeocoding]="field.mapConfig?.enableGeocoding !== false"
                [enableLocationPicker]="field.mapConfig?.enableLocationPicker !== false"
                [style]="field.mapConfig?.style || 'liberty'"
                >
              </app-map-libre-picker>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- ðŸ–Šï¸ Digital Signature Field -->
          @if (field.type === 'signature') {
            <div class="signature-field">
              <!-- Digital signature component with all configuration options -->
              <app-digital-signature
                [formControlName]="field.name"
                [label]="field.label"
                [placeholder]="field.placeholder"
                [canvasWidth]="field.signatureConfig?.canvasWidth || 600"
                [canvasHeight]="field.signatureConfig?.canvasHeight || 200"
                [strokeColor]="field.signatureConfig?.strokeColor || '#000000'"
                [strokeWidth]="field.signatureConfig?.strokeWidth || 2"
                [backgroundColor]="field.signatureConfig?.backgroundColor || '#FFFFFF'"
                >
              </app-digital-signature>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- ðŸ“¸ Picture Upload Field -->
          @if (field.type === 'picture') {
            <div class="picture-field">
              @if (field.label) {
                <label class="field-label">{{ field.label }}</label>
              }
              <app-picture-upload
                [formControlName]="field.name"
                [placeholder]="field.pictureConfig?.placeholder || field.placeholder || 'Add Picture'"
                [maxFileSize]="field.pictureConfig?.maxFileSize || 5242880"
                [acceptedTypes]="field.pictureConfig?.acceptedTypes || ['image/jpeg', 'image/png', 'image/webp', 'image/gif']"
                [required]="!!field.required"
                [disabled]="form.get(field.name)?.disabled || false"
                (error)="onPictureError($event, field.name)"
                >
              </app-picture-upload>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- ðŸ·ï¸ Label Field (Display-only text) -->
          @if (field.type === 'label') {
            <div class="label-field" [ngClass]="getLabelClasses(field)">
              <div class="label-content" [ngStyle]="getLabelStyles(field)">
                {{ field.text || field.label }}
              </div>
            </div>
          }
        </div>
      }
    </ng-template>
