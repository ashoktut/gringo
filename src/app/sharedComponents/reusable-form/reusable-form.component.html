<div class="form-container">
  @if (formTitle) {
    <h2 class="form-title">{{ formTitle }}</h2>
  }

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dynamic-form">
    <!-- NEW: Grouped mode with sections -->
    @if (sections?.length) {
      <mat-accordion [multi]="multi">
        @for (section of sections; track trackBySection($index, section)) {
          <mat-expansion-panel
            [expanded]="section.expanded || false"
            >
            <mat-expansion-panel-header>
              <mat-panel-title>{{ section.title }}</mat-panel-title>
              @if (section.description) {
                <mat-panel-description>
                  {{ section.description }}
                </mat-panel-description>
              }
            </mat-expansion-panel-header>
            @for (field of section.fields; track trackByFieldName($index, field)) {
              <ng-container
                [ngTemplateOutlet]="fieldTemplate"
                [ngTemplateOutletContext]="{ $implicit: field }"
                >
              </ng-container>
            }
          </mat-expansion-panel>
        }
      </mat-accordion>
    } @else {
      @for (field of fields; track trackByFieldName($index, field)) {
        <ng-container
          [ngTemplateOutlet]="fieldTemplate"
          [ngTemplateOutletContext]="{ $implicit: field }"
          >
        </ng-container>
      }
    }

    <!-- UPDATED: Flat mode (backward compatible) -->

    <div class="form-actions">
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="!isFormValid()"
        class="submit-button"
        >
        {{ submitButtonText }}
      </button>

      <!-- ✅ ADD: Debug info (remove in production) -->
      <div
        class="debug-info"
        style="margin-top: 10px; font-size: 12px; color: #666"
        >
        Form Valid (Angular): {{ form.valid }}<br />
        Form Valid (Custom): {{ isFormValid() }}<br />
        Form Touched: {{ form.touched }}<br />
        Form Dirty: {{ form.dirty }}
      </div>
    </div>
  </form>
</div>

<!-- NEW: Shared field template (moved all your existing field code here) -->
<ng-template #fieldTemplate let-field>
  @if (shouldShowField(field)) {
    <div [formGroup]="form">
      <!-- Input Fields (text, email, password, number, tel) -->
      @if (isInputField(field.type)) {
        <mat-form-field
          appearance="fill"
          class="full-width"
          >
          <mat-label>{{ field.label }}</mat-label>
          <input
            matInput
            [type]="field.type"
            [formControlName]="field.name"
            [placeholder]="field.placeholder || ''"
            [required]="!!field.required"
            />
            <!-- Clear button -->
            @if (field.clearable) {
              <button
                mat-icon-button
                matSuffix
                type="button"
                aria-label="Clear"
                (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                (click)="clearField(field, $event)"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
            @if (hasFieldError(field.name)) {
              <mat-error>
                {{ getFieldError(field.name) }}
              </mat-error>
            }
          </mat-form-field>
        }
        <!-- Date Picker -->
        @if (field.type === 'date') {
          <mat-form-field
            appearance="fill"
            class="full-width"
            >
            <mat-label>{{ field.label }}</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || 'DD/MM/YYYY'"
              [required]="!!field.required"
              />
              <!-- Clear button for date -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear date"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              <mat-datepicker-toggle
                matIconSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Select Dropdown -->
          @if (field.type === 'select') {
            <mat-form-field
              appearance="fill"
              class="full-width"
              >
              <mat-label>{{ field.label }}</mat-label>
              <mat-select
                [formControlName]="field.name"
                [multiple]="!!field.multiple"
                [required]="!!field.required"
                >
                @for (option of field.options; track option) {
                  <mat-option [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                }
              </mat-select>
              <!-- Clear button for select -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear selection"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Textarea -->
          @if (field.type === 'textarea') {
            <mat-form-field
              appearance="fill"
              class="full-width"
              >
              <mat-label>{{ field.label }}</mat-label>
              <textarea
                matInput
                [formControlName]="field.name"
                [placeholder]="field.placeholder || ''"
                [rows]="field.rows || 3"
                [required]="!!field.required"
                >
              </textarea>
              <!-- Clear button for textarea -->
              @if (field.clearable) {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  aria-label="Clear text"
                  (pointerdown)="$event.preventDefault(); $event.stopPropagation()"
                  (click)="clearField(field, $event)"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
              @if (hasFieldError(field.name)) {
                <mat-error>
                  {{ getFieldError(field.name) }}
                </mat-error>
              }
            </mat-form-field>
          }
          <!-- Checkbox -->
          @if (field.type === 'checkbox') {
            <div class="checkbox-field">
              <mat-checkbox [formControlName]="field.name">
                {{ field.label }}
              </mat-checkbox>
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- Radio Group -->
          @if (field.type === 'radio') {
            <div class="radio-field">
              <label class="field-label">{{ field.label }}</label>
              <mat-radio-group [formControlName]="field.name" class="radio-group">
                @for (option of field.options; track option) {
                  <mat-radio-button
                    [value]="option.value"
                    class="radio-button"
                    >
                    {{ option.label }}
                  </mat-radio-button>
                }
              </mat-radio-group>
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- MapLibre Map Field -->
          @if (field.type === 'map') {
            <div class="map-field">
              <!-- Field label -->
              <label class="field-label">{{ field.label }}</label>
              <!-- Map picker component with all configuration options -->
              <app-map-libre-picker
                [formControlName]="field.name"
                [defaultCenter]="field.mapConfig?.defaultCenter || [28.0473, -26.2041]"
                [zoom]="field.mapConfig?.zoom || 10"
                [height]="field.mapConfig?.height || '400px'"
                [enableGeocoding]="field.mapConfig?.enableGeocoding !== false"
                [enableLocationPicker]="field.mapConfig?.enableLocationPicker !== false"
                [style]="field.mapConfig?.style || 'liberty'"
                >
              </app-map-libre-picker>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- 🖊️ Digital Signature Field -->
          @if (field.type === 'signature') {
            <div class="signature-field">
              <!-- Digital signature component with all configuration options -->
              <app-digital-signature
                [formControlName]="field.name"
                [label]="field.label"
                [placeholder]="field.placeholder"
                [canvasWidth]="field.signatureConfig?.canvasWidth || 600"
                [canvasHeight]="field.signatureConfig?.canvasHeight || 200"
                [strokeColor]="field.signatureConfig?.strokeColor || '#000000'"
                [strokeWidth]="field.signatureConfig?.strokeWidth || 2"
                [backgroundColor]="field.signatureConfig?.backgroundColor || '#FFFFFF'"
                >
              </app-digital-signature>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- 📸 Picture Upload Field -->
          @if (field.type === 'picture') {
            <div class="picture-field">
              @if (field.label) {
                <label class="field-label">{{ field.label }}</label>
              }
              <app-picture-upload
                [formControlName]="field.name"
                [placeholder]="field.pictureConfig?.placeholder || field.placeholder || 'Add Picture'"
                [maxFileSize]="field.pictureConfig?.maxFileSize || 5242880"
                [acceptedTypes]="field.pictureConfig?.acceptedTypes || ['image/jpeg', 'image/png', 'image/webp', 'image/gif']"
                [required]="!!field.required"
                [disabled]="form.get(field.name)?.disabled || false"
                (error)="onPictureError($event, field.name)"
                >
              </app-picture-upload>
              <!-- Show validation errors if any -->
              @if (hasFieldError(field.name)) {
                <div class="mat-error">
                  {{ getFieldError(field.name) }}
                </div>
              }
            </div>
          }
          <!-- 🏷️ Label Field (Display-only text) -->
          @if (field.type === 'label') {
            <div class="label-field" [ngClass]="getLabelClasses(field)">
              <div class="label-content" [ngStyle]="getLabelStyles(field)">
                {{ field.text || field.label }}
              </div>
            </div>
          }
        </div>
      }
    </ng-template>
