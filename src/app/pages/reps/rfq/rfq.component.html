<div class="page-container">
  <div class="form-header">
    <h1>
      {{ isRepeatMode ? 'Repeat Request For Quote (RFQ)' : 'Request For Quote (RFQ)' }}
    </h1>
    @if (!isRepeatMode) {
      <p>
        Complete the form section by section. Click on a section header to expand it - only one section can be open at a time.
      </p>
    }
    @if (isRepeatMode) {
      <div class="repeat-notice">
        <mat-icon>refresh</mat-icon>
        <p>
          Creating new RFQ based on submission #{{ originalSubmissionId?.split('-')?.[1] || originalSubmissionId }}.
          Review and update as needed.
        </p>
      </div>
    }

    <!-- Company Selection -->
    @if (availableCompanies.length > 0) {
      <mat-card class="company-selector-card">
        <mat-card-content>
          <div class="company-selector">
            <mat-icon>business</mat-icon>
            <mat-form-field appearance="outline" class="company-field">
              <mat-label>Select Company Configuration</mat-label>
              <mat-select
                [value]="selectedCompanyId"
                (selectionChange)="onCompanyChange($event.value)"
                placeholder="Default Configuration">
                <mat-option [value]="null">Default Configuration</mat-option>
                @for (company of availableCompanies; track company) {
                  <mat-option [value]="company">{{ company }}</mat-option>
                }
              </mat-select>
              <mat-hint>Choose company-specific form configuration</mat-hint>
            </mat-form-field>
            @if (currentFormConfig) {
              <div class="config-info">
                <mat-chip-set>
                  <mat-chip [disabled]="true">
                    <mat-icon matChipAvatar>settings</mat-icon>
                    {{ currentFormConfig.name }}
                  </mat-chip>
                  @if (currentFormConfig.companyId) {
                    <mat-chip [disabled]="true" color="primary">
                      <mat-icon matChipAvatar>business</mat-icon>
                      {{ currentFormConfig.companyId }}
                    </mat-chip>
                  }
                  @if (currentFormConfig.isDefault) {
                    <mat-chip [disabled]="true" color="accent">
                      <mat-icon matChipAvatar>star</mat-icon>
                      Default
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- Loading State -->
  @if (isLoadingConfig) {
    <mat-card class="loading-card">
      <mat-card-content>
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading form configuration...</p>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Error State -->
  @if (configLoadError && !isLoadingConfig) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-container">
          <mat-icon color="warn">error</mat-icon>
          <h3>Configuration Error</h3>
          <p>Unable to load form configuration. Using default configuration.</p>
          <button mat-raised-button color="primary" (click)="loadFormConfiguration()">
            <mat-icon>refresh</mat-icon>
            Retry
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Form Content -->
  @if (!isLoadingConfig && rfqSections.length > 0) {
    <app-reusable-form
      [sections]="rfqSections"
      [multi]="false"
      [formTitle]="isRepeatMode ? 'Repeat RFQ Form' : 'RFQ Form'"
      [submitButtonText]="isRepeatMode ? 'Submit Repeated RFQ' : 'Submit RFQ'"
      [initialData]="isRepeatMode ? repeatedSubmissionData : initialFormData"
      (formSubmit)="onFormSubmit($event)"
      (formValueChange)="onFormValueChange($event)">
    </app-reusable-form>
  }
</div>
